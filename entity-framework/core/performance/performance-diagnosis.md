---
title: Diagnosi delle prestazioni-EF Core
description: Diagnosi delle prestazioni Entity Framework Core e identificazione dei colli di bottiglia
author: roji
ms.date: 12/1/2020
uid: core/performance/performance-diagnosis
ms.openlocfilehash: 9416acf3326056ef7a5d732c4bd456dac751167b
ms.sourcegitcommit: 4860d036ea0fb392c28799907bcc924c987d2d7b
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 12/17/2020
ms.locfileid: "97657805"
---
# <a name="performance-diagnosis"></a><span data-ttu-id="c5c0c-103">Diagnosi delle prestazioni</span><span class="sxs-lookup"><span data-stu-id="c5c0c-103">Performance Diagnosis</span></span>

<span data-ttu-id="c5c0c-104">In questa sezione vengono descritte le modalità di rilevamento dei problemi di prestazioni nell'applicazione EF e una volta identificata un'area problematica, come analizzarla ulteriormente per identificare il problema principale.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-104">This section discusses ways for detecting performance issues in your EF application, and once a problematic area has been identified, how to further analyze them to identify the root problem.</span></span> <span data-ttu-id="c5c0c-105">È importante diagnosticare e analizzare attentamente eventuali problemi prima di passare a qualsiasi conclusione ed evitare di presumere dove si trova la radice del problema.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-105">It's important to carefully diagnose and investigate any problems before jumping to any conclusions, and to avoid assuming where the root of the issue is.</span></span>

## <a name="identifying-slow-database-commands-via-logging"></a><span data-ttu-id="c5c0c-106">Identificazione di comandi di database lenti tramite registrazione</span><span class="sxs-lookup"><span data-stu-id="c5c0c-106">Identifying slow database commands via logging</span></span>

<span data-ttu-id="c5c0c-107">Alla fine della giornata, EF prepara ed esegue i comandi da eseguire nel database. con il database relazionale, ovvero l'esecuzione di istruzioni SQL tramite l'API del database ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-107">At the end of the day, EF prepares and executes commands to be executed against your database; with relational database, that means executing SQL statements via the ADO.NET database API.</span></span> <span data-ttu-id="c5c0c-108">Se una determinata query sta richiedendo troppo tempo, ad esempio perché manca un indice, è possibile individuarlo esaminando i log di esecuzione dei comandi e osservando il tempo necessario.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-108">If a certain query is taking too much time (e.g. because an index is missing), this can be seen discovered by inspecting command execution logs and observing how long they actually take.</span></span>

<span data-ttu-id="c5c0c-109">EF rende molto semplice acquisire i tempi di esecuzione del comando tramite una [semplice registrazione](xref:core/logging-events-diagnostics/simple-logging) o [Microsoft. Extensions. Logging](xref:core/logging-events-diagnostics/extensions-logging):</span><span class="sxs-lookup"><span data-stu-id="c5c0c-109">EF makes it very easy to capture command execution times, via either [simple logging](xref:core/logging-events-diagnostics/simple-logging) or [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging):</span></span>

### <a name="simple-logging"></a>[<span data-ttu-id="c5c0c-110">Registrazione semplice</span><span class="sxs-lookup"><span data-stu-id="c5c0c-110">Simple logging</span></span>](#tab/simple-logging)

[!code-csharp[Main](../../../samples/core/Performance/BloggingContext.cs#SimpleLogging)]

### <a name="microsoftextensionslogging"></a>[<span data-ttu-id="c5c0c-111">Microsoft.Extensions.Logging</span><span class="sxs-lookup"><span data-stu-id="c5c0c-111">Microsoft.Extensions.Logging</span></span>](#tab/microsoft-extensions-logging)

[!code-csharp[Main](../../../samples/core/Performance/ExtensionsLoggingContext.cs#ExtensionsLogging)]

***

<span data-ttu-id="c5c0c-112">Quando il livello di registrazione è impostato su `LogLevel.Information` , EF genera un messaggio di log per ogni esecuzione del comando con il tempo impiegato:</span><span class="sxs-lookup"><span data-stu-id="c5c0c-112">When the logging level is set at `LogLevel.Information`, EF emits a log message for each command execution with the time taken:</span></span>

```log
info: 06/12/2020 09:12:36.117 RelationalEventId.CommandExecuted[20101] (Microsoft.EntityFrameworkCore.Database.Command)
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT [b].[Id], [b].[Name]
      FROM [Blogs] AS [b]
      WHERE [b].[Name] = N'foo'
```

<span data-ttu-id="c5c0c-113">Il comando precedente ha impiegato 4 millisecondi.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-113">The above command took 4 milliseconds.</span></span> <span data-ttu-id="c5c0c-114">Se un determinato comando richiede più del previsto, si è trovato un possibile colpevole per un problema di prestazioni e ora è possibile concentrarsi su di esso per capire il motivo per cui viene eseguito lentamente.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-114">If a certain command takes more than expected, you've found a possible culprit for a performance issue, and can now focus on it to understand why it's running slowly.</span></span> <span data-ttu-id="c5c0c-115">La registrazione dei comandi può anche rivelare i casi in cui vengono eseguiti round trip di database imprevisti; Questa operazione viene visualizzata come più comandi in cui è previsto solo uno.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-115">Command logging can also reveal cases where unexpected database roundtrips are being made; this would show up as multiple commands where only one is expected.</span></span>

> [!WARNING]
> <span data-ttu-id="c5c0c-116">La registrazione dell'esecuzione dei comandi abilitata nell'ambiente di produzione non è in genere una buona idea.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-116">Leaving command execution logging enabled in your production environment is usually a bad idea.</span></span> <span data-ttu-id="c5c0c-117">La registrazione rallenta l'applicazione e può creare rapidamente file di log di grandi dimensioni che possono riempire il disco del server.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-117">The logging itself slows down your application, and may quickly create huge log files which can fill up your server's disk.</span></span> <span data-ttu-id="c5c0c-118">È consigliabile proseguire solo per un breve intervallo di tempo per raccogliere dati, monitorando con attenzione l'applicazione, oppure per acquisire i dati di registrazione in un sistema di pre-produzione.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-118">It's recommended to only keep logging on for a short interval of time to gather data - while carefully monitoring your application - or to capture logging data on a pre-production system.</span></span>

## <a name="correlating-database-commands-to-linq-queries"></a><span data-ttu-id="c5c0c-119">Correlazione di comandi di database a query LINQ</span><span class="sxs-lookup"><span data-stu-id="c5c0c-119">Correlating database commands to LINQ queries</span></span>

<span data-ttu-id="c5c0c-120">Un problema con la registrazione dell'esecuzione dei comandi è che talvolta è difficile correlare query SQL e query LINQ: i comandi SQL eseguiti da EF possono essere molto diversi dalle query LINQ da cui sono state generate.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-120">One problem with command execution logging is that it's sometimes difficult to correlate SQL queries and LINQ queries: the SQL commands executed by EF can look very different from the LINQ queries from which they were generated.</span></span> <span data-ttu-id="c5c0c-121">Per risolvere questo problema, è consigliabile usare la funzionalità [tag di query](xref:core/querying/tags) di EF, che consente di inserire un piccolo commento di identificazione nella query SQL:</span><span class="sxs-lookup"><span data-stu-id="c5c0c-121">To help with this difficulty, you may want to use EF's [query tags](xref:core/querying/tags) feature, which allows you to inject a small, identifying comment into the SQL query:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tags/Program.cs#BasicQueryTag)]

<span data-ttu-id="c5c0c-122">Il tag viene visualizzato nei log:</span><span class="sxs-lookup"><span data-stu-id="c5c0c-122">The tag shows up in the logs:</span></span>

```sql
-- This is my spatial query!

SELECT TOP(@__p_1) [p].[Id], [p].[Location]
FROM [People] AS [p]
ORDER BY [p].[Location].STDistance(@__myLocation_0) DESC
```

<span data-ttu-id="c5c0c-123">Spesso è opportuno contrassegnare le query principali di un'applicazione in questo modo, per rendere i log di esecuzione dei comandi più immediatamente leggibili.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-123">It's often worth tagging the major queries of an application in this way, to make the command execution logs more immediately readable.</span></span>

## <a name="other-interfaces-for-capturing-performance-data"></a><span data-ttu-id="c5c0c-124">Altre interfacce per l'acquisizione dei dati sulle prestazioni</span><span class="sxs-lookup"><span data-stu-id="c5c0c-124">Other interfaces for capturing performance data</span></span>

<span data-ttu-id="c5c0c-125">Esistono diverse alternative alla funzionalità di registrazione di EF per l'acquisizione dei tempi di esecuzione dei comandi, che potrebbero essere più potenti.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-125">There are various alternatives to EF's logging feature for capturing command execution times, which may be more powerful.</span></span> <span data-ttu-id="c5c0c-126">I database sono in genere dotati di strumenti di analisi e analisi delle prestazioni, che in genere forniscono informazioni più dettagliate, specifiche del database, oltre ai semplici tempi di esecuzione. la configurazione, le funzionalità e l'utilizzo effettivi variano notevolmente tra i database.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-126">Databases typically come with their own tracing and performance analysis tools, which usually provide much richer, database-specific information beyond simple execution times; the actual setup, capabilities and usage vary considerably across databases.</span></span>

<span data-ttu-id="c5c0c-127">[SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms) è ad esempio un potente client in grado di connettersi all'istanza di SQL Server e fornire informazioni importanti sulla gestione e sulle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-127">For example, [SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms) is a powerful client that can connect to your SQL Server  instance and provide valuable management and performance information.</span></span> <span data-ttu-id="c5c0c-128">Esula dall'ambito di questa sezione per approfondire i dettagli, ma due funzionalità che vale la pena citare sono [monitoraggio attività](/sql/relational-databases/performance-monitor/open-activity-monitor-sql-server-management-studio), che fornisce un dashboard attivo dell'attività del server (incluse le query più dispendiose) e la funzionalità [degli eventi estesi (XEvent)](/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server) , che consente di definire sessioni di acquisizione dati arbitrarie che possono essere personalizzate in base alle esigenze specifiche.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-128">It's beyond the scope of this section to go into the details, but two capabilities worth mentioning are the [Activity Monitor](/sql/relational-databases/performance-monitor/open-activity-monitor-sql-server-management-studio), which provides a live dashboard of server activity (including the most expensive queries), and the [Extended Events (XEvent)](/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server) feature, which allows defining arbitrary data capture sessions which can be tailored to your exact needs.</span></span> <span data-ttu-id="c5c0c-129">[La documentazione di SQL Server sul monitoraggio](/sql/relational-databases/performance/monitor-and-tune-for-performance) fornisce ulteriori informazioni su queste funzionalità e su altre.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-129">[The SQL Server documentation on monitoring](/sql/relational-databases/performance/monitor-and-tune-for-performance) provides more information on these features, as well as others.</span></span>

<span data-ttu-id="c5c0c-130">Un altro approccio per l'acquisizione dei dati sulle prestazioni consiste nel raccogliere le informazioni emesse automaticamente da EF o dal driver di database tramite l' `DiagnosticSource` interfaccia, quindi analizzare i dati o visualizzarli in un dashboard.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-130">Another approach for capturing performance data is to collect information automatically emitted by either EF or the database driver via the `DiagnosticSource` interface, and then analyze that data or display it on a dashboard.</span></span> <span data-ttu-id="c5c0c-131">Se si usa Azure, [applicazione Azure Insights](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-performance) offre un monitoraggio efficace, integrando le prestazioni del database e i tempi di esecuzione delle query nell'analisi della velocità con cui vengono gestite le richieste Web.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-131">If you are using Azure, then [Azure Application Insights](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-performance) provides such powerful monitoring out of the box, integrating database performance and query execution times in the analysis of how quickly your web requests are being served.</span></span> <span data-ttu-id="c5c0c-132">Altre informazioni su questo sono disponibili nell' [esercitazione sulle prestazioni Application Insights](/azure/azure-monitor/learn/tutorial-performance)e nella [pagina analisi SQL di Azure](/azure/azure-monitor/insights/azure-sql).</span><span class="sxs-lookup"><span data-stu-id="c5c0c-132">More information on this is available in the [Application Insights performance tutorial](/azure/azure-monitor/learn/tutorial-performance), and in the [Azure SQL analytics page](/azure/azure-monitor/insights/azure-sql).</span></span>

## <a name="inspecting-query-execution-plans"></a><span data-ttu-id="c5c0c-133">Controllo dei piani di esecuzione delle query</span><span class="sxs-lookup"><span data-stu-id="c5c0c-133">Inspecting query execution plans</span></span>

<span data-ttu-id="c5c0c-134">Una volta individuata una query problematica che richiede l'ottimizzazione, il passaggio successivo consiste in genere nell'analisi del *piano di esecuzione* della query.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-134">Once you've pinpointed a problematic query that requires optimization, the next step is usually analyzing the query's *execution plan*.</span></span> <span data-ttu-id="c5c0c-135">Quando i database ricevono un'istruzione SQL, in genere producono un piano di come deve essere eseguito il piano; Questa operazione richiede a volte un processo decisionale complesso, in base al quale sono stati definiti gli indici, alla quantità di dati presenti nelle tabelle e così via. il piano deve essere in genere memorizzato nella cache del server per ottenere prestazioni ottimali.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-135">When databases receive a SQL statement, they typically produce a plan of how that plan is to be executed; this sometimes requires complicated decision-making based on which indexes have been defined, how much data exists in tables, etc. (incidentally, the plan itself should usually be cached at the server for optimal performance).</span></span> <span data-ttu-id="c5c0c-136">Nei database relazionali viene in genere fornito un modo per consentire agli utenti di visualizzare il piano di query, insieme al costo calcolato per parti diverse della query; Questa operazione è utile per migliorare le query.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-136">Relational databases typically provide a way for users to see the query plan, along with calculated costing for different parts of the query; this is invaluable for improving your queries.</span></span>

<span data-ttu-id="c5c0c-137">Per iniziare a usare SQL Server, vedere la documentazione relativa ai [piani di esecuzione delle query](/sql/relational-databases/performance/execution-plans).</span><span class="sxs-lookup"><span data-stu-id="c5c0c-137">To get started on SQL Server, see the documentation on [query execution plans](/sql/relational-databases/performance/execution-plans).</span></span> <span data-ttu-id="c5c0c-138">Il flusso di lavoro di analisi tipico consiste nell'utilizzare [SQL Server Management Studio](/sql/relational-databases/performance/display-an-actual-execution-plan), incollando il SQL di una query lenta identificata tramite uno dei mezzi precedenti e [producendo un piano di esecuzione grafico](/sql/relational-databases/performance/display-an-actual-execution-plan):</span><span class="sxs-lookup"><span data-stu-id="c5c0c-138">The typical analysis workflow would be to use [SQL Server Management Studio](/sql/relational-databases/performance/display-an-actual-execution-plan), pasting the SQL of a slow query identified via one of the means above, and [producing a graphical execution plan](/sql/relational-databases/performance/display-an-actual-execution-plan):</span></span>

![Visualizzazione di un piano di esecuzione SQL Server](_static/actualexecplan.png)

<span data-ttu-id="c5c0c-140">Sebbene i piani di esecuzione possano sembrare complicati inizialmente, vale la pena spendere una certa quantità di tempo per conoscerli.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-140">While execution plans may seem complicated at first, it's worth spending a bit of time getting familiar with them.</span></span> <span data-ttu-id="c5c0c-141">È particolarmente importante notare i costi associati a ogni nodo del piano e per identificare la modalità di utilizzo degli indici (o meno) nei vari nodi.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-141">It's particularly important to note the costs associated with each node of the plan, and to identify how indexes are used (or not) in the various nodes.</span></span>

<span data-ttu-id="c5c0c-142">Sebbene le informazioni precedenti siano specifiche per SQL Server, gli altri database forniscono in genere lo stesso tipo di strumenti con una visualizzazione simile.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-142">While the above information is specific to SQL Server, other databases typically provide the same kind of tools with similar visualization.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c5c0c-143">I database a volte generano piani di query diversi a seconda dei dati effettivi nel database.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-143">Databases sometimes generate different query plans depending on actual data in the database.</span></span> <span data-ttu-id="c5c0c-144">Se, ad esempio, una tabella contiene solo poche righe, è possibile che un database scelga di non utilizzare un indice in tale tabella, ma per eseguire un'analisi completa della tabella.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-144">For example, if a table contains only a few rows, a database may choose not to use an index on that table, but to perform a full table scan instead.</span></span> <span data-ttu-id="c5c0c-145">Se si analizzano i piani di query in un database di prova, verificare sempre che contenga dati simili al sistema di produzione.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-145">If analyzing query plans on a test database, always make sure it contains data that is similar to your production system.</span></span>

## <a name="event-counters"></a><span data-ttu-id="c5c0c-146">Contatori di eventi</span><span class="sxs-lookup"><span data-stu-id="c5c0c-146">Event counters</span></span>

<span data-ttu-id="c5c0c-147">Le sezioni precedenti incentrate su come ottenere informazioni sui comandi e sul modo in cui questi comandi vengono eseguiti nel database.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-147">The above sections focused on how to get information about your commands, and how these commands are executed in the database.</span></span> <span data-ttu-id="c5c0c-148">Inoltre, EF espone un set di *contatori di eventi* che forniscono informazioni più di livello inferiore sulle operazioni eseguite all'interno di EF e su come viene usato dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-148">In addition to that, EF exposes a set of *event counters* which provide more lower-level information on what's happening inside EF itself, and how your application is using it.</span></span> <span data-ttu-id="c5c0c-149">Questi contatori possono essere molto utili per la diagnosi di problemi di prestazioni e di anomalie delle prestazioni specifici, ad esempio [problemi di memorizzazione nella cache delle query](xref:core/performance/advanced-performance-topics#dynamically-constructed-queries) che causano ricompilazioni costanti, perdite di DbContext non disdisposte e altre ancora.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-149">These counters can be very useful for diagnosing specific performance issues and performance anomalies, such as [query caching issues](xref:core/performance/advanced-performance-topics#dynamically-constructed-queries) which cause constant recompilation, undisposed DbContext leaks, and others.</span></span>

<span data-ttu-id="c5c0c-150">Per ulteriori informazioni, vedere la pagina dedicata sui [contatori degli eventi di EF](xref:core/logging-events-diagnostics/event-counters) .</span><span class="sxs-lookup"><span data-stu-id="c5c0c-150">See the dedicated page on [EF's event counters](xref:core/logging-events-diagnostics/event-counters) for more information.</span></span>

## <a name="benchmarking-with-ef-core"></a><span data-ttu-id="c5c0c-151">Benchmarking con EF Core</span><span class="sxs-lookup"><span data-stu-id="c5c0c-151">Benchmarking with EF Core</span></span>

<span data-ttu-id="c5c0c-152">Alla fine della giornata, a volte è necessario sapere se un particolare metodo di scrittura o di esecuzione di una query è più veloce rispetto a un altro.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-152">At the end of the day, you sometimes need to know whether a particular way of writing or executing a query is faster than another.</span></span> <span data-ttu-id="c5c0c-153">È importante non presupporre o speculare la risposta ed è estremamente semplice mettere insieme un benchmark rapido per ottenere la risposta.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-153">It's important to never assume or speculate the answer, and it's extremely easy to put together a quick benchmark to get the answer.</span></span> <span data-ttu-id="c5c0c-154">Quando si scrivono i benchmark, è consigliabile usare la nota libreria [BenchmarkDotNet](https://benchmarkdotnet.org/index.html) , che gestisce molti problemi riscontrati dagli utenti durante il tentativo di scrivere i propri benchmark: sono state eseguite alcune iterazioni di riscaldamento?</span><span class="sxs-lookup"><span data-stu-id="c5c0c-154">When writing benchmarks, it's strongly recommended to use the well-known [BenchmarkDotNet](https://benchmarkdotnet.org/index.html) library, which handles many pitfalls users encounter when trying to write their own benchmarks: have you performed some warmup iterations?</span></span> <span data-ttu-id="c5c0c-155">Quante iterazioni eseguono effettivamente il benchmark e perché?</span><span class="sxs-lookup"><span data-stu-id="c5c0c-155">How many iterations does your benchmark actually run, and why?</span></span> <span data-ttu-id="c5c0c-156">Verrà ora esaminato il benchmark con EF Core.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-156">Let's take a look at what a benchmark with EF Core looks like.</span></span>

> [!TIP]
> <span data-ttu-id="c5c0c-157">Il progetto di benchmark completo per l'origine seguente è disponibile [qui](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs).</span><span class="sxs-lookup"><span data-stu-id="c5c0c-157">The full benchmark project for the source below is available [here](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs).</span></span> <span data-ttu-id="c5c0c-158">Si consiglia di copiarlo e usarlo come modello per i propri benchmark.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-158">You are encouraged to copy it and use it as a template for your own benchmarks.</span></span>

<span data-ttu-id="c5c0c-159">Come semplice scenario di benchmark, è possibile confrontare i seguenti metodi diversi per calcolare la classificazione media di tutti i Blog nel database:</span><span class="sxs-lookup"><span data-stu-id="c5c0c-159">As a simple benchmark scenario, let's compare the following different methods of calculating the average ranking of all Blogs in our database:</span></span>

* <span data-ttu-id="c5c0c-160">Caricare tutte le entità, sommare le rispettive classificazioni e calcolare la media.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-160">Load all entities, sum up their individual rankings, and calculate the average.</span></span>
* <span data-ttu-id="c5c0c-161">Analogamente a quanto sopra, utilizzare solo una query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-161">The same as above, only use a non-tracking query.</span></span> <span data-ttu-id="c5c0c-162">Questa operazione dovrebbe essere più veloce, perché la risoluzione delle identità non viene eseguita e le entità non sono snapshotted ai fini del rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-162">This should be faster, since identity resolution isn't performed, and the entities aren't snapshotted for the purposes of change tracking.</span></span>
* <span data-ttu-id="c5c0c-163">Evitare di caricare le intere istanze di entità del Blog, proiettando solo la classificazione.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-163">Avoid loading the entire Blog entity instances at all, by projecting out the ranking only.</span></span> <span data-ttu-id="c5c0c-164">Il non consente di trasferire le altre colonne non necessarie del tipo di entità Blog.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-164">The saves us from transferring the other, unneeded columns of the Blog entity type.</span></span>
* <span data-ttu-id="c5c0c-165">Calcolare la media nel database facendola parte della query.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-165">Calculate the average in the database by making it part of the query.</span></span> <span data-ttu-id="c5c0c-166">Questo è il modo più veloce, poiché tutto viene calcolato nel database e solo il risultato viene trasferito al client.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-166">This should be the fastest way, since everything is calculated in the database and only the result is transferred back to the client.</span></span>

<span data-ttu-id="c5c0c-167">Con BenchmarkDotNet è possibile scrivere il codice per eseguire il benchmarking come metodo semplice, proprio come un unit test e BenchmarkDotNet esegue automaticamente ogni metodo per un numero sufficiente di iterazioni, misurando in modo affidabile il tempo necessario e la quantità di memoria allocata.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-167">With BenchmarkDotNet, you write the code to be benchmarked as a simple method - just like a unit test - and BenchmarkDotNet automatically runs each method for sufficient number of iterations, reliably measuring how long it takes and how much memory is allocated.</span></span> <span data-ttu-id="c5c0c-168">Ecco il metodo diverso ([il codice di benchmark completo può essere visualizzato qui](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs)):</span><span class="sxs-lookup"><span data-stu-id="c5c0c-168">Here are the different method ([the full benchmark code can be seen here](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs)):</span></span>

### <a name="load-entities"></a>[<span data-ttu-id="c5c0c-169">Carica entità</span><span class="sxs-lookup"><span data-stu-id="c5c0c-169">Load entities</span></span>](#tab/load-entities)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=LoadEntities)]

### <a name="load-entities-no-tracking"></a>[<span data-ttu-id="c5c0c-170">Carica entità, nessun rilevamento</span><span class="sxs-lookup"><span data-stu-id="c5c0c-170">Load entities, no tracking</span></span>](#tab/load-entities-no-tracking)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=LoadEntitiesNoTracking)]

### <a name="project-only-ranking"></a>[<span data-ttu-id="c5c0c-171">Classificazione solo progetto</span><span class="sxs-lookup"><span data-stu-id="c5c0c-171">Project only ranking</span></span>](#tab/project-only-ranking)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=ProjectOnlyRanking)]

### <a name="calculate-in-database"></a>[<span data-ttu-id="c5c0c-172">Calcola nel database</span><span class="sxs-lookup"><span data-stu-id="c5c0c-172">Calculate in database</span></span>](#tab/calculate-in-database)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=CalculateInDatabase)]

***

<span data-ttu-id="c5c0c-173">I risultati sono riportati di seguito, come stampato da BenchmarkDotNet:</span><span class="sxs-lookup"><span data-stu-id="c5c0c-173">The results are below, as printed by BenchmarkDotNet:</span></span>

|                 <span data-ttu-id="c5c0c-174">Metodo</span><span class="sxs-lookup"><span data-stu-id="c5c0c-174">Method</span></span> |       <span data-ttu-id="c5c0c-175">Media</span><span class="sxs-lookup"><span data-stu-id="c5c0c-175">Mean</span></span> |    <span data-ttu-id="c5c0c-176">Errore</span><span class="sxs-lookup"><span data-stu-id="c5c0c-176">Error</span></span> |   <span data-ttu-id="c5c0c-177">StdDev</span><span class="sxs-lookup"><span data-stu-id="c5c0c-177">StdDev</span></span> |     <span data-ttu-id="c5c0c-178">Mediana</span><span class="sxs-lookup"><span data-stu-id="c5c0c-178">Median</span></span> | <span data-ttu-id="c5c0c-179">Proporzioni</span><span class="sxs-lookup"><span data-stu-id="c5c0c-179">Ratio</span></span> | <span data-ttu-id="c5c0c-180">RatioSD</span><span class="sxs-lookup"><span data-stu-id="c5c0c-180">RatioSD</span></span> |    <span data-ttu-id="c5c0c-181">Generazione 0</span><span class="sxs-lookup"><span data-stu-id="c5c0c-181">Gen 0</span></span> |   <span data-ttu-id="c5c0c-182">Generazione 1</span><span class="sxs-lookup"><span data-stu-id="c5c0c-182">Gen 1</span></span> | <span data-ttu-id="c5c0c-183">Generazione 2</span><span class="sxs-lookup"><span data-stu-id="c5c0c-183">Gen 2</span></span> |  <span data-ttu-id="c5c0c-184">Allocato</span><span class="sxs-lookup"><span data-stu-id="c5c0c-184">Allocated</span></span> |
|----------------------- |-----------:|---------:|---------:|-----------:|------:|--------:|---------:|--------:|------:|-----------:|
|           <span data-ttu-id="c5c0c-185">LoadEntities</span><span class="sxs-lookup"><span data-stu-id="c5c0c-185">LoadEntities</span></span> | <span data-ttu-id="c5c0c-186">2.860,4 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-186">2,860.4 us</span></span> | <span data-ttu-id="c5c0c-187">54,31 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-187">54.31 us</span></span> | <span data-ttu-id="c5c0c-188">93,68 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-188">93.68 us</span></span> | <span data-ttu-id="c5c0c-189">2.844,5 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-189">2,844.5 us</span></span> |  <span data-ttu-id="c5c0c-190">4.55</span><span class="sxs-lookup"><span data-stu-id="c5c0c-190">4.55</span></span> |    <span data-ttu-id="c5c0c-191">0,33</span><span class="sxs-lookup"><span data-stu-id="c5c0c-191">0.33</span></span> | <span data-ttu-id="c5c0c-192">210,9375</span><span class="sxs-lookup"><span data-stu-id="c5c0c-192">210.9375</span></span> | <span data-ttu-id="c5c0c-193">70,3125</span><span class="sxs-lookup"><span data-stu-id="c5c0c-193">70.3125</span></span> |     - | <span data-ttu-id="c5c0c-194">1309,56 KB</span><span class="sxs-lookup"><span data-stu-id="c5c0c-194">1309.56 KB</span></span> |
| <span data-ttu-id="c5c0c-195">LoadEntitiesNoTracking</span><span class="sxs-lookup"><span data-stu-id="c5c0c-195">LoadEntitiesNoTracking</span></span> | <span data-ttu-id="c5c0c-196">1.353,0 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-196">1,353.0 us</span></span> | <span data-ttu-id="c5c0c-197">21,26 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-197">21.26 us</span></span> | <span data-ttu-id="c5c0c-198">18,85 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-198">18.85 us</span></span> | <span data-ttu-id="c5c0c-199">1.355,6 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-199">1,355.6 us</span></span> |  <span data-ttu-id="c5c0c-200">2.10</span><span class="sxs-lookup"><span data-stu-id="c5c0c-200">2.10</span></span> |    <span data-ttu-id="c5c0c-201">0.14</span><span class="sxs-lookup"><span data-stu-id="c5c0c-201">0.14</span></span> |  <span data-ttu-id="c5c0c-202">87,8906</span><span class="sxs-lookup"><span data-stu-id="c5c0c-202">87.8906</span></span> |  <span data-ttu-id="c5c0c-203">3,9063</span><span class="sxs-lookup"><span data-stu-id="c5c0c-203">3.9063</span></span> |     - |  <span data-ttu-id="c5c0c-204">540,09 KB</span><span class="sxs-lookup"><span data-stu-id="c5c0c-204">540.09 KB</span></span> |
|     <span data-ttu-id="c5c0c-205">ProjectOnlyRanking</span><span class="sxs-lookup"><span data-stu-id="c5c0c-205">ProjectOnlyRanking</span></span> |   <span data-ttu-id="c5c0c-206">910,9 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-206">910.9 us</span></span> | <span data-ttu-id="c5c0c-207">20,91 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-207">20.91 us</span></span> | <span data-ttu-id="c5c0c-208">61,65 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-208">61.65 us</span></span> |   <span data-ttu-id="c5c0c-209">892,9 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-209">892.9 us</span></span> |  <span data-ttu-id="c5c0c-210">1,46</span><span class="sxs-lookup"><span data-stu-id="c5c0c-210">1.46</span></span> |    <span data-ttu-id="c5c0c-211">0.14</span><span class="sxs-lookup"><span data-stu-id="c5c0c-211">0.14</span></span> |  <span data-ttu-id="c5c0c-212">41,0156</span><span class="sxs-lookup"><span data-stu-id="c5c0c-212">41.0156</span></span> |  <span data-ttu-id="c5c0c-213">0,9766</span><span class="sxs-lookup"><span data-stu-id="c5c0c-213">0.9766</span></span> |     - |  <span data-ttu-id="c5c0c-214">252,08 KB</span><span class="sxs-lookup"><span data-stu-id="c5c0c-214">252.08 KB</span></span> |
|    <span data-ttu-id="c5c0c-215">CalculateInDatabase</span><span class="sxs-lookup"><span data-stu-id="c5c0c-215">CalculateInDatabase</span></span> |   <span data-ttu-id="c5c0c-216">627,1 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-216">627.1 us</span></span> | <span data-ttu-id="c5c0c-217">14,58 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-217">14.58 us</span></span> | <span data-ttu-id="c5c0c-218">42,54 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-218">42.54 us</span></span> |   <span data-ttu-id="c5c0c-219">626,4 US</span><span class="sxs-lookup"><span data-stu-id="c5c0c-219">626.4 us</span></span> |  <span data-ttu-id="c5c0c-220">1,00</span><span class="sxs-lookup"><span data-stu-id="c5c0c-220">1.00</span></span> |    <span data-ttu-id="c5c0c-221">0,00</span><span class="sxs-lookup"><span data-stu-id="c5c0c-221">0.00</span></span> |   <span data-ttu-id="c5c0c-222">4,8828</span><span class="sxs-lookup"><span data-stu-id="c5c0c-222">4.8828</span></span> |       - |     - |   <span data-ttu-id="c5c0c-223">33,27 KB</span><span class="sxs-lookup"><span data-stu-id="c5c0c-223">33.27 KB</span></span> |

> [!NOTE]
> <span data-ttu-id="c5c0c-224">Poiché i metodi creano ed eliminano il contesto all'interno del metodo, queste operazioni vengono conteggiate per il benchmark, sebbene non facciano parte del processo di query.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-224">As the methods instantiate and dispose the context within the method, these operations are counted for the benchmark, although strictly speaking they are not part of the querying process.</span></span> <span data-ttu-id="c5c0c-225">Questa operazione non è importante se l'obiettivo è confrontare due alternative tra loro (poiché la creazione di un'istanza e l'eliminazione del contesto sono le stesse) e fornisce una misura più olistica per l'intera operazione.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-225">This should not matter if the goal is to compare two alternatives to one another (since the context instantiation and disposal are the same), and gives a more holistic measurement for the entire operation.</span></span>

<span data-ttu-id="c5c0c-226">Una limitazione di BenchmarkDotNet è che consente di misurare le prestazioni semplici a thread singolo dei metodi forniti e pertanto non è particolarmente adatto per il benchmarking degli scenari simultanei.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-226">One limitation of BenchmarkDotNet is that it measures simple, single-thread performance of the methods you provide, and is therefore not well-suited for benchmarking concurrent scenarios.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c5c0c-227">Assicurarsi sempre che nel database siano presenti dati simili ai dati di produzione durante il benchmarking. in caso contrario, i risultati del benchmark potrebbero non rappresentare le prestazioni effettive nell'ambiente di produzione.</span><span class="sxs-lookup"><span data-stu-id="c5c0c-227">Always make sure to have data in your database that is similar to production data when benchmarking, otherwise the benchmark results may not represent actual performance in production.</span></span>
