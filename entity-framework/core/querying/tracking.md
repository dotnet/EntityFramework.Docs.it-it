---
title: Confronto tra query di rilevamento e No-Tracking-EF Core
description: Informazioni sulle query di rilevamento e senza rilevamento in Entity Framework Core
author: smitpatel
ms.date: 11/09/2020
uid: core/querying/tracking
ms.openlocfilehash: 1b3c1db702438390c0de4a2ad5d13e868a522b65
ms.sourcegitcommit: 032a1767d7a6e42052a005f660b80372c6521e7e
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/12/2021
ms.locfileid: "98128901"
---
# <a name="tracking-vs-no-tracking-queries"></a><span data-ttu-id="d7aa7-103">Rilevamento e query No-Tracking</span><span class="sxs-lookup"><span data-stu-id="d7aa7-103">Tracking vs. No-Tracking Queries</span></span>

<span data-ttu-id="d7aa7-104">Il rilevamento del comportamento Controlla se Entity Framework Core manterrà le informazioni su un'istanza di entità nel relativo strumento di rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-104">Tracking behavior controls if Entity Framework Core will keep information about an entity instance in its change tracker.</span></span> <span data-ttu-id="d7aa7-105">Se un'entità viene inclusa nel rilevamento delle modifiche, qualsiasi modifica individuata per l'entità verrà salvata in modo permanente nel database durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-105">If an entity is tracked, any changes detected in the entity will be persisted to the database during `SaveChanges()`.</span></span> <span data-ttu-id="d7aa7-106">EF Core correggerà anche le proprietà di navigazione tra le entità in un risultato della query di rilevamento e le entità presenti nello strumento di rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-106">EF Core will also fix up navigation properties between the entities in a tracking query result and the entities that are in the change tracker.</span></span>

> [!NOTE]
> <span data-ttu-id="d7aa7-107">I [tipi di entità senza chiave](xref:core/modeling/keyless-entity-types) non vengono mai rilevati.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-107">[Keyless entity types](xref:core/modeling/keyless-entity-types) are never tracked.</span></span> <span data-ttu-id="d7aa7-108">Quando in questo articolo vengono citati i tipi di entità, si riferisce ai tipi di entità con una chiave definita.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-108">Wherever this article mentions entity types, it refers to entity types which have a key defined.</span></span>

> [!TIP]
> <span data-ttu-id="d7aa7-109">È possibile visualizzare l'[esempio](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying/Tracking) di questo articolo in GitHub.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-109">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying/Tracking) on GitHub.</span></span>

## <a name="tracking-queries"></a><span data-ttu-id="d7aa7-110">Query con rilevamento delle modifiche</span><span class="sxs-lookup"><span data-stu-id="d7aa7-110">Tracking queries</span></span>

<span data-ttu-id="d7aa7-111">Per impostazione predefinita, le query che restituiscono tipi di entità sono con rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-111">By default, queries that return entity types are tracking.</span></span> <span data-ttu-id="d7aa7-112">Ciò significa che è possibile apportare modifiche a tali istanze di entità e rendere le modifiche rese permanente da `SaveChanges()` .</span><span class="sxs-lookup"><span data-stu-id="d7aa7-112">Which means you can make changes to those entity instances and have those changes persisted by `SaveChanges()`.</span></span> <span data-ttu-id="d7aa7-113">Nell'esempio seguente la modifica della classificazione del blog verrà rilevata e salvata in modo permanente nel database durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-113">In the following example, the change to the blogs rating will be detected and persisted to the database during `SaveChanges()`.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#Tracking)]

<span data-ttu-id="d7aa7-114">Quando i risultati vengono restituiti in una query di rilevamento, EF Core verificherà se l'entità è già presente nel contesto.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-114">When the results are returned in a tracking query, EF Core will check if the entity is already in the context.</span></span> <span data-ttu-id="d7aa7-115">Se EF Core trova un'entità esistente, viene restituita la stessa istanza.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-115">If EF Core finds an existing entity, then the same instance is returned.</span></span> <span data-ttu-id="d7aa7-116">EF Core non sovrascrive i valori correnti e originali delle proprietà dell'entità nella voce con i valori del database.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-116">EF Core won't overwrite current and original values of the entity's properties in the entry with the database values.</span></span> <span data-ttu-id="d7aa7-117">Se l'entità non viene trovata nel contesto, EF Core creerà una nuova istanza dell'entità e la collegherà al contesto.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-117">If the entity isn't found in the context, then EF Core will create new entity instance and attach it to the context.</span></span> <span data-ttu-id="d7aa7-118">I risultati della query non contengono alcuna entità, che viene aggiunta al contesto ma non ancora salvata nel database.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-118">Query results don't contain any entity, which is added to the context but not yet saved to the database.</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="d7aa7-119">Query senza registrazione</span><span class="sxs-lookup"><span data-stu-id="d7aa7-119">No-tracking queries</span></span>

<span data-ttu-id="d7aa7-120">Le query senza rilevamento delle modifiche sono utili quando i risultati vengono usati in uno scenario di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-120">No tracking queries are useful when the results are used in a read-only scenario.</span></span> <span data-ttu-id="d7aa7-121">Sono più veloci da eseguire perché non è necessario impostare le informazioni sul rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-121">They're quicker to execute because there's no need to set up the change tracking information.</span></span> <span data-ttu-id="d7aa7-122">Se non è necessario aggiornare le entità recuperate dal database, è necessario utilizzare una query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-122">If you don't need to update the entities retrieved from the database, then a no-tracking query should be used.</span></span> <span data-ttu-id="d7aa7-123">È possibile scambiare una singola query senza tracciare.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-123">You can swap an individual query to be no-tracking.</span></span> <span data-ttu-id="d7aa7-124">Nessuna query di rilevamento fornirà inoltre i risultati in base a ciò che si trova nel database, a causa delle modifiche locali o delle entità aggiunte.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-124">No tracking query will also give you results based on what is in the database disregarding any local changes or added entities.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#NoTracking)]

<span data-ttu-id="d7aa7-125">È anche possibile modificare il comportamento predefinito di rilevamento delle modifiche a livello di istanza di contesto:</span><span class="sxs-lookup"><span data-stu-id="d7aa7-125">You can also change the default tracking behavior at the context instance level:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ContextDefaultTrackingBehavior)]

## <a name="identity-resolution"></a><span data-ttu-id="d7aa7-126">Risoluzione di identità</span><span class="sxs-lookup"><span data-stu-id="d7aa7-126">Identity resolution</span></span>

<span data-ttu-id="d7aa7-127">Poiché una query di rilevamento USA change tracker, EF Core eseguirà la risoluzione delle identità in una query di rilevamento.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-127">Since a tracking query uses the change tracker, EF Core will do identity resolution in a tracking query.</span></span> <span data-ttu-id="d7aa7-128">Quando si materializzazione un'entità, EF Core restituirà la stessa istanza dell'entità dallo strumento di rilevamento delle modifiche, se è già stata rilevata.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-128">When materializing an entity, EF Core will return the same entity instance from the change tracker if it's already being tracked.</span></span> <span data-ttu-id="d7aa7-129">Se il risultato contiene la stessa entità più volte, viene restituita la stessa istanza per ogni occorrenza.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-129">If the result contains same entity multiple times, you get back same instance for each occurrence.</span></span> <span data-ttu-id="d7aa7-130">Le query senza rilevamento non usano change tracker e non eseguono la risoluzione delle identità.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-130">No-tracking queries don't use the change tracker and don't do identity resolution.</span></span> <span data-ttu-id="d7aa7-131">Quindi, si ottiene una nuova istanza dell'entità anche quando la stessa entità è contenuta nel risultato più volte.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-131">So you get back new instance of entity even when the same entity is contained in the result multiple times.</span></span> <span data-ttu-id="d7aa7-132">Questo comportamento è diverso nelle versioni precedenti EF Core 3,0, vedere [versioni precedenti](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="d7aa7-132">This behavior was different in versions before EF Core 3.0, see [previous versions](#previous-versions).</span></span>

<span data-ttu-id="d7aa7-133">A partire da EF Core 5,0, è possibile combinare entrambi i comportamenti precedenti nella stessa query.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-133">Starting with EF Core 5.0, you can combine both of the above behaviors in same query.</span></span> <span data-ttu-id="d7aa7-134">Ovvero, è possibile avere una query senza rilevamento, che eseguirà la risoluzione delle identità nei risultati.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-134">That is, you can have a no tracking query, which will do identity resolution in the results.</span></span> <span data-ttu-id="d7aa7-135">Analogamente all' `AsNoTracking()` operatore Queryable, è stato aggiunto un altro operatore `AsNoTrackingWithIdentityResolution()` .</span><span class="sxs-lookup"><span data-stu-id="d7aa7-135">Just like `AsNoTracking()` queryable operator, we've added another operator `AsNoTrackingWithIdentityResolution()`.</span></span> <span data-ttu-id="d7aa7-136">In Enum è stata aggiunta anche la voce associata <xref:Microsoft.EntityFrameworkCore.QueryTrackingBehavior> .</span><span class="sxs-lookup"><span data-stu-id="d7aa7-136">There's also associated entry added in <xref:Microsoft.EntityFrameworkCore.QueryTrackingBehavior> enum.</span></span> <span data-ttu-id="d7aa7-137">Quando si configura la query in modo che utilizzi la risoluzione delle identità senza rilevamento, viene utilizzato uno strumento di rilevamento delle modifiche autonomo in background durante la generazione dei risultati della query in modo che ogni istanza venga materializzata una sola volta.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-137">When you configure the query to use identity resolution with no tracking, we use a stand-alone change tracker in the background when generating query results so each instance is materialized only once.</span></span> <span data-ttu-id="d7aa7-138">Poiché questo strumento di rilevamento delle modifiche è diverso da quello nel contesto, i risultati non vengono rilevati dal contesto.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-138">Since this change tracker is different from the one in the context, the results are not tracked by the context.</span></span> <span data-ttu-id="d7aa7-139">Dopo che la query è stata enumerata completamente, lo strumento di rilevamento delle modifiche esce dall'ambito e sottoposto a Garbage Collection come richiesto.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-139">After the query is enumerated fully, the change tracker goes out of scope and garbage collected as required.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#NoTrackingWithIdentityResolution)]

## <a name="tracking-and-custom-projections"></a><span data-ttu-id="d7aa7-140">Rilevamento e proiezioni personalizzate</span><span class="sxs-lookup"><span data-stu-id="d7aa7-140">Tracking and custom projections</span></span>

<span data-ttu-id="d7aa7-141">Anche se il tipo di risultato della query non è un tipo di entità, EF Core continuerà a tenere traccia dei tipi di entità contenuti nel risultato per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-141">Even if the result type of the query isn't an entity type, EF Core will still track entity types contained in the result by default.</span></span> <span data-ttu-id="d7aa7-142">Nella query seguente, che restituisce un tipo anonimo, le istanze di `Blog` nel set di risultati verranno incluse nel rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-142">In the following query, which returns an anonymous type, the instances of `Blog` in the result set will be tracked.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection1)]

<span data-ttu-id="d7aa7-143">Se il set di risultati contiene tipi di entità provenienti dalla composizione LINQ, EF Core li terrà traccia.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-143">If the result set contains entity types coming out from LINQ composition, EF Core will track them.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection2)]

<span data-ttu-id="d7aa7-144">Se il set di risultati non contiene tipi di entità, non viene eseguita alcuna verifica.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-144">If the result set doesn't contain any entity types, then no tracking is done.</span></span> <span data-ttu-id="d7aa7-145">Nella query seguente viene restituito un tipo anonimo con alcuni valori dell'entità, ma nessuna istanza del tipo di entità effettivo.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-145">In the following query, we return an anonymous type with some of the values from the entity (but no instances of the actual entity type).</span></span> <span data-ttu-id="d7aa7-146">Nessuna entità rilevata esce dalla query.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-146">There are no tracked entities coming out of the query.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection3)]

 <span data-ttu-id="d7aa7-147">EF Core supporta la valutazione dei client nella proiezione di primo livello.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-147">EF Core supports doing client evaluation in the top-level projection.</span></span> <span data-ttu-id="d7aa7-148">Se EF Core materializza un'istanza di entità per la valutazione client, verrà rilevata.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-148">If EF Core materializes an entity instance for client evaluation, it will be tracked.</span></span> <span data-ttu-id="d7aa7-149">Qui, poiché `blog` le entità vengono passate al metodo client `StandardizeURL` , EF Core tiene traccia anche delle istanze del Blog.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-149">Here, since we're passing `blog` entities to the client method `StandardizeURL`, EF Core will track the blog instances too.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientMethod)]

<span data-ttu-id="d7aa7-150">EF Core non tiene traccia delle istanze di entità senza chiave contenute nel risultato.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-150">EF Core doesn't track the keyless entity instances contained in the result.</span></span> <span data-ttu-id="d7aa7-151">Tuttavia EF Core tiene traccia di tutte le altre istanze dei tipi di entità con chiave in base alle regole precedenti.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-151">But EF Core tracks all the other instances of entity types with key according to rules above.</span></span>

<span data-ttu-id="d7aa7-152">Alcune delle regole precedenti hanno funzionato in modo diverso prima di EF Core 3,0.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-152">Some of the above rules worked differently before EF Core 3.0.</span></span> <span data-ttu-id="d7aa7-153">Per ulteriori informazioni, vedere [versioni precedenti](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="d7aa7-153">For more information, see [previous versions](#previous-versions).</span></span>

## <a name="previous-versions"></a><span data-ttu-id="d7aa7-154">Versioni precedenti</span><span class="sxs-lookup"><span data-stu-id="d7aa7-154">Previous versions</span></span>

<span data-ttu-id="d7aa7-155">Prima della versione 3,0, EF Core aveva alcune differenze nel modo in cui il rilevamento è stato eseguito.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-155">Before version 3.0, EF Core had some differences in how tracking was done.</span></span> <span data-ttu-id="d7aa7-156">Di seguito sono riportate le differenze rilevanti:</span><span class="sxs-lookup"><span data-stu-id="d7aa7-156">Notable differences are as follows:</span></span>

- <span data-ttu-id="d7aa7-157">Come illustrato nella pagina di [valutazione del client rispetto al server](xref:core/querying/client-eval) , EF core la valutazione client supportata in qualsiasi parte della query prima della versione 3,0.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-157">As explained in [Client vs Server Evaluation](xref:core/querying/client-eval) page, EF Core supported client evaluation in any part of the query before version 3.0.</span></span> <span data-ttu-id="d7aa7-158">La valutazione client ha causato la materializzazione delle entità, che non fanno parte del risultato.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-158">Client evaluation caused materialization of entities, which weren't part of the result.</span></span> <span data-ttu-id="d7aa7-159">Quindi EF Core analizzato il risultato per rilevare gli elementi di cui tenere traccia. Questa progettazione presenta alcune differenze, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="d7aa7-159">So EF Core analyzed the result to detect what to track. This design had certain differences as follows:</span></span>
  - <span data-ttu-id="d7aa7-160">Valutazione client nella proiezione, che ha causato la materializzazione ma non ha restituito l'istanza di entità materializzata non è stata rilevata.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-160">Client evaluation in the projection, which caused materialization but didn't return the materialized entity instance wasn't tracked.</span></span> <span data-ttu-id="d7aa7-161">Nell'esempio seguente non è stata tenuta traccia delle `blog` entità.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-161">The following example didn't track `blog` entities.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientProjection)]

  - <span data-ttu-id="d7aa7-162">In alcuni casi EF Core non tiene traccia degli oggetti che provengono dalla composizione LINQ.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-162">EF Core didn't track the objects coming out of LINQ composition in certain cases.</span></span> <span data-ttu-id="d7aa7-163">L'esempio seguente non è stato rilevato `Post` .</span><span class="sxs-lookup"><span data-stu-id="d7aa7-163">The following example didn't track `Post`.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection2)]

- <span data-ttu-id="d7aa7-164">Ogni volta che i risultati della query contengono tipi di entità senza chiave, l'intera query è stata eseguita senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-164">Whenever query results contained keyless entity types, the whole query was made non-tracking.</span></span> <span data-ttu-id="d7aa7-165">Ciò significa che i tipi di entità con chiavi, che non sono presenti nel risultato, non sono stati rilevati.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-165">That means that entity types with keys, which are in result weren't being tracked either.</span></span>
- <span data-ttu-id="d7aa7-166">EF Core ha fatto la risoluzione delle identità in una query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-166">EF Core did identity resolution in no-tracking query.</span></span> <span data-ttu-id="d7aa7-167">Sono stati usati riferimenti deboli per tenere traccia delle entità che erano già state restituite.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-167">It used weak references to keep track of entities that had already been returned.</span></span> <span data-ttu-id="d7aa7-168">Quindi, se un set di risultati contiene la stessa entità più volte, si otterrebbe la stessa istanza per ogni occorrenza.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-168">So if a result set contained the same entity multiples times, you would get the same instance for each occurrence.</span></span> <span data-ttu-id="d7aa7-169">Tuttavia, se un risultato precedente con la stessa identità è uscito dall'ambito e viene sottoposta a Garbage Collection, EF Core ha restituito una nuova istanza.</span><span class="sxs-lookup"><span data-stu-id="d7aa7-169">Though if a previous result with the same identity went out of scope and got garbage collected, EF Core returned a new instance.</span></span>
