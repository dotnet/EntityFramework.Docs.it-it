---
title: Utilizzo dei tipi di riferimento Nullable-EF Core
description: Utilizzo di tipi di riferimento Nullable C# quando si utilizza Entity Framework Core
author: roji
ms.date: 09/09/2019
uid: core/miscellaneous/nullable-reference-types
ms.openlocfilehash: 0747b1328458fbaddd9e3cca117e378bbad5b365
ms.sourcegitcommit: 704240349e18b6404e5a809f5b7c9d365b152e2e
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 02/16/2021
ms.locfileid: "100543432"
---
# <a name="working-with-nullable-reference-types"></a><span data-ttu-id="2d841-103">Utilizzo dei tipi di riferimento Nullable</span><span class="sxs-lookup"><span data-stu-id="2d841-103">Working with Nullable Reference Types</span></span>

<span data-ttu-id="2d841-104">In C# 8 è stata introdotta una nuova funzionalità denominata [tipi di riferimento Nullable (NRT)](/dotnet/csharp/tutorials/nullable-reference-types), che consente di aggiungere annotazioni ai tipi di riferimento, indicando se è valido per consentirne la presenza di valori null.</span><span class="sxs-lookup"><span data-stu-id="2d841-104">C# 8 introduced a new feature called [nullable reference types (NRT)](/dotnet/csharp/tutorials/nullable-reference-types), allowing reference types to be annotated, indicating whether it is valid for them to contain null or not.</span></span> <span data-ttu-id="2d841-105">Se non si ha familiarità con questa funzionalità, è consigliabile prenderne nota leggendo i documenti in C#.</span><span class="sxs-lookup"><span data-stu-id="2d841-105">If you are new to this feature, it is recommended that make yourself familiar with it by reading the C# docs.</span></span>

<span data-ttu-id="2d841-106">Questa pagina introduce il supporto di EF Core per i tipi di riferimento nullable e descrive le procedure consigliate per l'utilizzo.</span><span class="sxs-lookup"><span data-stu-id="2d841-106">This page introduces EF Core's support for nullable reference types, and describes best practices for working with them.</span></span>

## <a name="required-and-optional-properties"></a><span data-ttu-id="2d841-107">Proprietà obbligatorie e facoltative</span><span class="sxs-lookup"><span data-stu-id="2d841-107">Required and optional properties</span></span>

<span data-ttu-id="2d841-108">La documentazione principale sulle proprietà obbligatorie e facoltative e la relativa interazione con i tipi di riferimento Nullable è la pagina delle [proprietà obbligatoria e facoltativa](xref:core/modeling/entity-properties#required-and-optional-properties) .</span><span class="sxs-lookup"><span data-stu-id="2d841-108">The main documentation on required and optional properties and their interaction with nullable reference types is the [Required and Optional Properties](xref:core/modeling/entity-properties#required-and-optional-properties) page.</span></span> <span data-ttu-id="2d841-109">È consigliabile iniziare leggendo prima di tutto la pagina.</span><span class="sxs-lookup"><span data-stu-id="2d841-109">It is recommended you start out by reading that page first.</span></span>

> [!NOTE]
> <span data-ttu-id="2d841-110">Prestare attenzione quando si abilitano i tipi di riferimento nullable in un progetto esistente: le proprietà del tipo di riferimento che in precedenza erano configurate come facoltative ora verranno configurate come richieste, a meno che non vengano annotate in modo esplicito come Nullable.</span><span class="sxs-lookup"><span data-stu-id="2d841-110">Exercise caution when enabling nullable reference types on an existing project: reference type properties which were previously configured as optional will now be configured as required, unless they are explicitly annotated to be nullable.</span></span> <span data-ttu-id="2d841-111">Quando si gestisce uno schema di database relazionale, è possibile che vengano generate migrazioni che modificano il supporto di valori null per la colonna di database.</span><span class="sxs-lookup"><span data-stu-id="2d841-111">When managing a relational database schema, this may cause migrations to be generated which alter the database column's nullability.</span></span>

## <a name="non-nullable-properties-and-initialization"></a><span data-ttu-id="2d841-112">Proprietà e inizializzazione non nullable</span><span class="sxs-lookup"><span data-stu-id="2d841-112">Non-nullable properties and initialization</span></span>

<span data-ttu-id="2d841-113">Quando sono abilitati i tipi di riferimento Nullable, il compilatore C# genera avvisi per qualsiasi proprietà non nullable non inizializzata, in quanto questi contengono valori null.</span><span class="sxs-lookup"><span data-stu-id="2d841-113">When nullable reference types are enabled, the C# compiler emits warnings for any uninitialized non-nullable property, as these would contain null.</span></span> <span data-ttu-id="2d841-114">Di conseguenza, non è possibile usare il modo comune seguente per scrivere i tipi di entità:</span><span class="sxs-lookup"><span data-stu-id="2d841-114">As a result, the following, common way of writing entity types cannot be used:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/CustomerWithWarning.cs?name=CustomerWithWarning&highlight=5-6)]

<span data-ttu-id="2d841-115">Il [binding del costruttore](xref:core/modeling/constructors) è una tecnica utile per garantire che le proprietà non nullable siano inizializzate:</span><span class="sxs-lookup"><span data-stu-id="2d841-115">[Constructor binding](xref:core/modeling/constructors) is a useful technique to ensure that your non-nullable properties are initialized:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/CustomerWithConstructorBinding.cs?name=CustomerWithConstructorBinding&highlight=6-9)]

<span data-ttu-id="2d841-116">Sfortunatamente, in alcuni scenari il binding del costruttore non è un'opzione. le proprietà di navigazione, ad esempio, non possono essere inizializzate in questo modo.</span><span class="sxs-lookup"><span data-stu-id="2d841-116">Unfortunately, in some scenarios constructor binding isn't an option; navigation properties, for example, cannot be initialized in this way.</span></span>

<span data-ttu-id="2d841-117">Le proprietà di navigazione obbligatorie presentano un ulteriore problema: Sebbene un dipendente esista sempre per un'entità specifica, può essere caricato o meno da una determinata query, a seconda delle esigenze in quel punto del programma ([vedere i diversi modelli per il caricamento dei dati](xref:core/querying/related-data)).</span><span class="sxs-lookup"><span data-stu-id="2d841-117">Required navigation properties present an additional difficulty: although a dependent will always exist for a given principal, it may or may not be loaded by a particular query, depending on the needs at that point in the program ([see the different patterns for loading data](xref:core/querying/related-data)).</span></span> <span data-ttu-id="2d841-118">Allo stesso tempo, è preferibile rendere tali proprietà Nullable, in quanto ciò impone l'accesso a tutti gli accessi per verificare la presenza di valori null, anche se sono necessari.</span><span class="sxs-lookup"><span data-stu-id="2d841-118">At the same time, it is undesirable to make these properties nullable, since that would force all access to them to check for null, even if they are required.</span></span>

<span data-ttu-id="2d841-119">Un modo per gestire questi scenari consiste nel disporre di una proprietà che non ammette i valori null con un [campo](xref:core/modeling/backing-field)sottostante Nullable:</span><span class="sxs-lookup"><span data-stu-id="2d841-119">One way to deal with these scenarios, is to have a non-nullable property with a nullable [backing field](xref:core/modeling/backing-field):</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Order.cs?range=10-17)]

<span data-ttu-id="2d841-120">Poiché la proprietà di navigazione è non nullable, viene configurata una navigazione obbligatoria. fino a quando lo spostamento viene caricato correttamente, il dipendente sarà accessibile tramite la proprietà.</span><span class="sxs-lookup"><span data-stu-id="2d841-120">Since the navigation property is non-nullable, a required navigation is configured; and as long as the navigation is properly loaded, the dependent will be accessible via the property.</span></span> <span data-ttu-id="2d841-121">Se, tuttavia, viene eseguito l'accesso alla proprietà senza prima caricare correttamente l'entità correlata, viene generata un'eccezione InvalidOperationException, perché il contratto API è stato usato in modo errato.</span><span class="sxs-lookup"><span data-stu-id="2d841-121">If, however, the property is accessed without first properly loading the related entity, an InvalidOperationException is thrown, since the API contract has been used incorrectly.</span></span> <span data-ttu-id="2d841-122">Si noti che EF deve essere configurato per accedere sempre al campo sottostante e non alla proprietà, perché si basa sulla possibilità di leggere il valore anche quando viene annullato. per informazioni su come eseguire questa operazione, vedere la documentazione relativa ai [campi di supporto](xref:core/modeling/backing-field) e prendere in considerazione la possibilità di specificare `PropertyAccessMode.Field` per assicurarsi che la configurazione sia corretta.</span><span class="sxs-lookup"><span data-stu-id="2d841-122">Note that EF must be configured to always access the backing field and not the property, as it relies on being able to read the value even when unset; consult the documentation on [backing fields](xref:core/modeling/backing-field) on how to do this, and consider specifying `PropertyAccessMode.Field` to make sure the configuration is correct.</span></span>

<span data-ttu-id="2d841-123">Come alternativa Terser, è possibile semplicemente inizializzare la proprietà su null con l'ausilio dell'operatore con indulgenza null (!):</span><span class="sxs-lookup"><span data-stu-id="2d841-123">As a terser alternative, it is possible to simply initialize the property to null with the help of the null-forgiving operator (!):</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Order.cs?range=19)]

<span data-ttu-id="2d841-124">Un valore null effettivo non verrà mai osservato ad eccezione di come risultato di un bug di programmazione, ad esempio l'accesso alla proprietà di navigazione senza caricare correttamente l'entità correlata in precedenza.</span><span class="sxs-lookup"><span data-stu-id="2d841-124">An actual null value will never be observed except as a result of a programming bug, e.g. accessing the navigation property without properly loading the related entity beforehand.</span></span>

> [!NOTE]
> <span data-ttu-id="2d841-125">Le esplorazioni della raccolta, che contengono riferimenti a più entità correlate, devono essere sempre non nullable.</span><span class="sxs-lookup"><span data-stu-id="2d841-125">Collection navigations, which contain references to multiple related entities, should always be non-nullable.</span></span> <span data-ttu-id="2d841-126">Una raccolta vuota significa che non esiste alcuna entità correlata, ma l'elenco stesso non deve mai essere null.</span><span class="sxs-lookup"><span data-stu-id="2d841-126">An empty collection means that no related entities exist, but the list itself should never be null.</span></span>

## <a name="dbcontext-and-dbset"></a><span data-ttu-id="2d841-127">DbContext e DbSet</span><span class="sxs-lookup"><span data-stu-id="2d841-127">DbContext and DbSet</span></span>

<span data-ttu-id="2d841-128">Anche la pratica comune di disporre di proprietà DbSet non inizializzate sui tipi di contesto è problematica, in quanto il compilatore emetterà avvisi per tali proprietà.</span><span class="sxs-lookup"><span data-stu-id="2d841-128">The common practice of having uninitialized DbSet properties on context types is also problematic, as the compiler will now emit warnings for them.</span></span> <span data-ttu-id="2d841-129">Questo problema può essere risolto come segue:</span><span class="sxs-lookup"><span data-stu-id="2d841-129">This can be fixed as follows:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/NullableReferenceTypesContext.cs?name=Context&highlight=3-4)]

<span data-ttu-id="2d841-130">Un'altra strategia consiste nell'usare le proprietà automatiche che non ammettono i valori null, ma per inizializzarle su null, usando l'operatore di indulgenza null (!) per disattivare l'avviso del compilatore.</span><span class="sxs-lookup"><span data-stu-id="2d841-130">Another strategy is to use non-nullable auto-properties, but to initialize them to null, using the null-forgiving operator (!) to silence the compiler warning.</span></span> <span data-ttu-id="2d841-131">Il costruttore di base DbContext garantisce che tutte le proprietà DbSet vengano inizializzate e null non verrà mai osservato su di essi.</span><span class="sxs-lookup"><span data-stu-id="2d841-131">The DbContext base constructor ensures that all DbSet properties will get initialized, and null will never be observed on them.</span></span>

## <a name="navigating-and-including-nullable-relationships"></a><span data-ttu-id="2d841-132">Esplorazione e inclusione di relazioni Nullable</span><span class="sxs-lookup"><span data-stu-id="2d841-132">Navigating and including nullable relationships</span></span>

<span data-ttu-id="2d841-133">Quando si gestiscono relazioni facoltative, è possibile che si verifichino avvisi del compilatore in cui un'eccezione di riferimento null effettiva potrebbe non essere possibile.</span><span class="sxs-lookup"><span data-stu-id="2d841-133">When dealing with optional relationships, it's possible to encounter compiler warnings where an actual null reference exception would be impossible.</span></span> <span data-ttu-id="2d841-134">Quando si traducono ed eseguono le query LINQ, EF Core garantisce che se non esiste un'entità correlata facoltativa, eventuali spostamenti verranno semplicemente ignorati, anziché generare.</span><span class="sxs-lookup"><span data-stu-id="2d841-134">When translating and executing your LINQ queries, EF Core guarantees that if an optional related entity does not exist, any navigation to it will simply be ignored, rather than throwing.</span></span> <span data-ttu-id="2d841-135">Tuttavia, il compilatore non è a conoscenza di questo EF Core garanzia e genera avvisi come se la query LINQ venisse eseguita in memoria, con LINQ to Objects.</span><span class="sxs-lookup"><span data-stu-id="2d841-135">However, the compiler is unaware of this EF Core guarantee, and produces warnings as if the LINQ query were executed in memory, with LINQ to Objects.</span></span> <span data-ttu-id="2d841-136">Di conseguenza, è necessario usare l'operatore di perdonazione null (!) per informare il compilatore che non è possibile un valore null effettivo:</span><span class="sxs-lookup"><span data-stu-id="2d841-136">As a result, it is necessary to use the null-forgiving operator (!) to inform the compiler that an actual null value isn't possible:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Program.cs?name=Navigating)]

<span data-ttu-id="2d841-137">Si verifica un problema simile quando si includono più livelli di relazioni tra gli spostamenti facoltativi:</span><span class="sxs-lookup"><span data-stu-id="2d841-137">A similar issue occurs when including multiple levels of relationships across optional navigations:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Program.cs?name=Including&highlight=2)]

<span data-ttu-id="2d841-138">Se questa operazione viene eseguita molto e i tipi di entità in questione sono prevalentemente (o esclusivamente) usati nelle query di EF Core, è consigliabile rendere le proprietà di navigazione non nullable e configurarle come facoltative tramite l'API Fluent o le annotazioni dei dati.</span><span class="sxs-lookup"><span data-stu-id="2d841-138">If you find yourself doing this a lot, and the entity types in question are predominantly (or exclusively) used in EF Core queries, consider making the navigation properties non-nullable, and to configure them as optional via the Fluent API or Data Annotations.</span></span> <span data-ttu-id="2d841-139">Tutti gli avvisi del compilatore vengono rimossi mantenendo la relazione facoltativa. Tuttavia, se le entità vengono attraversate all'esterno di EF Core, è possibile osservare valori null anche se le proprietà sono annotate come non nullable.</span><span class="sxs-lookup"><span data-stu-id="2d841-139">This will remove all compiler warnings while keeping the relationship optional; however, if your entities are traversed outside of EF Core, you may observe null values although the properties are annotated as non-nullable.</span></span>

## <a name="limitations"></a><span data-ttu-id="2d841-140">Limitazioni</span><span class="sxs-lookup"><span data-stu-id="2d841-140">Limitations</span></span>

* <span data-ttu-id="2d841-141">Il reverse engineering attualmente non supporta i [tipi di riferimento Nullable di C# 8 (NRTs)](/dotnet/csharp/tutorials/nullable-reference-types): EF core genera sempre codice c# che presuppone che la funzionalità sia disattivata.</span><span class="sxs-lookup"><span data-stu-id="2d841-141">Reverse engineering does not currently support [C# 8 nullable reference types (NRTs)](/dotnet/csharp/tutorials/nullable-reference-types): EF Core always generates C# code that assumes the feature is off.</span></span> <span data-ttu-id="2d841-142">Ad esempio, le colonne di testo Nullable verranno sottoposto a impalcatura come proprietà con tipo `string` , non `string?` con l'API Fluent o le annotazioni dei dati utilizzate per configurare se una proprietà è obbligatoria o meno.</span><span class="sxs-lookup"><span data-stu-id="2d841-142">For example, nullable text columns will be scaffolded as a property with type `string` , not `string?`, with either the Fluent API or Data Annotations used to configure whether a property is required or not.</span></span> <span data-ttu-id="2d841-143">È possibile modificare il codice con impalcature e sostituirle con annotazioni di supporto per i valori null C#.</span><span class="sxs-lookup"><span data-stu-id="2d841-143">You can edit the scaffolded code and replace these with C# nullability annotations.</span></span> <span data-ttu-id="2d841-144">Il supporto dell'impalcatura per i tipi di riferimento nullable viene rilevato da Issue [#15520](https://github.com/dotnet/efcore/issues/15520).</span><span class="sxs-lookup"><span data-stu-id="2d841-144">Scaffolding support for nullable reference types is tracked by issue [#15520](https://github.com/dotnet/efcore/issues/15520).</span></span>
* <span data-ttu-id="2d841-145">La superficie dell'API pubblica di EF Core non è ancora stata annotata per il supporto di valori null (l'API pubblica è "ignaro null"), rendendo talvolta scomodo da usare quando la funzionalità NRT è attivata.</span><span class="sxs-lookup"><span data-stu-id="2d841-145">EF Core's public API surface has not yet been annotated for nullability (the public API is "null-oblivious"), making it sometimes awkward to use when the NRT feature is turned on.</span></span> <span data-ttu-id="2d841-146">In particolare, include gli operatori LINQ asincroni esposti da EF Core, ad esempio [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span><span class="sxs-lookup"><span data-stu-id="2d841-146">This notably includes the async LINQ operators exposed by EF Core, such as [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span></span> <span data-ttu-id="2d841-147">Si prevede di risolvere questo problema per la versione 6,0.</span><span class="sxs-lookup"><span data-stu-id="2d841-147">We plan to address this for the 6.0 release.</span></span>
